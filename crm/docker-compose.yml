# DEPRECATED: Use infra/docker-compose.yml with profiles instead.
# This file is kept for backward compatibility with Philip's running system.
# New installs should use: docker compose -f infra/docker-compose.yml --profile full up -d
#
# Robothor Docker Services — Vaultwarden, Uptime Kuma, Kokoro TTS
# All containers use host PostgreSQL (172.17.0.1:5432) and Redis (host.docker.internal:6379)
# Ports bound to 127.0.0.1 — external access only via Cloudflare tunnel

services:
  # --- Vaultwarden (password vault) ---
  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    extra_hosts:
      - "host.docker.internal:host-gateway"
    env_file: .env
    environment:
      DATABASE_URL: postgresql://philip:${PG_PASSWORD}@host.docker.internal:5432/vaultwarden
      DOMAIN: https://vault.robothor.ai
      SIGNUPS_ALLOWED: "false"
      ADMIN_TOKEN: ${VAULTWARDEN_ADMIN_TOKEN}
      ROCKET_PORT: "80"
      LOG_LEVEL: info
    ports:
      - "127.0.0.1:8222:80"
    volumes:
      - vaultwarden-data:/data
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512m

  # --- Kokoro TTS (local OpenAI-compatible TTS) ---
  kokoro-tts:
    image: ghcr.io/remsky/kokoro-fastapi-cpu:latest
    container_name: kokoro-tts
    restart: always
    ports:
      - "127.0.0.1:8880:8880"
    environment:
      - USE_GPU=false
      - DEVICE_TYPE=cpu
      - DEFAULT_VOICE=am_fenrir
      - SAMPLE_RATE=24000
      - ENABLE_WEB_PLAYER=false
      - API_LOG_LEVEL=INFO
      - DOWNLOAD_MODEL=true
    volumes:
      - kokoro-models:/app/api/src/models/v1_0
      - kokoro-voices:/app/api/src/voices/v1_0
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8880/v1/models"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 2g

  # --- Uptime Kuma (monitoring) ---
  uptime-kuma:
    image: louislam/uptime-kuma:1
    container_name: uptime-kuma
    ports:
      - "127.0.0.1:3010:3001"
    volumes:
      - uptime-kuma-data:/app/data
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512m

volumes:
  vaultwarden-data:
  uptime-kuma-data:
  kokoro-models:
  kokoro-voices:
